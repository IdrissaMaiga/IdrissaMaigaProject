<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="ShopAssistant.Views.CollectionPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ShopAssistant.ViewModels"
             xmlns:models="clr-namespace:ProductAssistant.Core.Models;assembly=ProductAssistant.Core"
             xmlns:converters="clr-namespace:ShopAssistant.Converters"
             x:DataType="vm:CollectionViewModel"
             Title="{Binding Title}"
             BackgroundColor="{StaticResource BackgroundSecondary}">
    
    <ContentPage.Resources>
        <converters:ImageUrlProxyConverter x:Key="ImageUrlProxyConverter"/>
    </ContentPage.Resources>
    
    <Grid RowDefinitions="Auto,Auto,*" Padding="0">
        
        <!-- Network Status Banner -->
        <Border Grid.Row="0"
                BackgroundColor="{StaticResource Error}"
                Padding="12,10"
                IsVisible="{Binding IsOnline, Converter={StaticResource InvertedBoolConverter}}">
            <HorizontalStackLayout Spacing="8"
                                  HorizontalOptions="Center">
                <Label Text="âš "
                       TextColor="White"
                       FontSize="16"
                       VerticalOptions="Center"/>
                <Label Text="{Binding NetworkStatus}"
                       TextColor="White"
                       FontSize="14"
                       FontAttributes="Bold"
                       VerticalOptions="Center" />
            </HorizontalStackLayout>
        </Border>
        
        <!-- Search Section -->
        <Border Grid.Row="1"
                BackgroundColor="White"
                Padding="12,16"
                Margin="12,12,12,12">
            <Border.StrokeShape>
                <RoundRectangle CornerRadius="12"/>
            </Border.StrokeShape>
            <Border.Shadow>
                <Shadow Brush="Black"
                        Offset="0,2"
                        Radius="8"
                        Opacity="0.08"/>
            </Border.Shadow>
            
            <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                <Border Grid.Column="0"
                        BackgroundColor="{StaticResource BackgroundSecondary}"
                        StrokeThickness="1"
                        Stroke="{StaticResource BorderMedium}">
                    <Border.StrokeShape>
                        <RoundRectangle CornerRadius="10"/>
                    </Border.StrokeShape>
                    <Entry Text="{Binding SearchText}"
                           Placeholder="Search your collection..."
                           PlaceholderColor="{StaticResource TextTertiary}"
                           TextColor="{StaticResource TextPrimary}"
                           BackgroundColor="Transparent"
                           FontSize="15"
                           Margin="12,0"
                           ReturnCommand="{Binding SearchProductsCommand}" />
                </Border>
                
                <Button Grid.Column="1"
                        Text="Search"
                        Command="{Binding SearchProductsCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontSize="14"
                        FontAttributes="Bold"
                        HeightRequest="48"
                        MinimumWidthRequest="80"
                        Padding="16,0"
                        CornerRadius="10"/>
            </Grid>
        </Border>

        <!-- Products Collection List -->
        <RefreshView Grid.Row="2"
                     IsRefreshing="{Binding IsRefreshing}"
                     Command="{Binding RefreshCommand}"
                     Margin="12,0,12,12">
            <CollectionView ItemsSource="{Binding Products}"
                          SelectionMode="None">
                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="40"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center">
                        <Label Text="ðŸ“š"
                               FontSize="64"
                               HorizontalOptions="Center"/>
                        <Label Text="Your collection is empty"
                               FontSize="18"
                               FontAttributes="Bold"
                               TextColor="{StaticResource TextPrimary}"
                               HorizontalOptions="Center"
                               Margin="0,16,0,4"/>
                        <Label Text="Add products from the chat conversation to build your collection"
                               FontSize="14"
                               TextColor="{StaticResource TextSecondary}"
                               HorizontalOptions="Center"
                               LineBreakMode="WordWrap"
                               Margin="0,0,0,8"/>
                        <Button Text="Go to Chat"
                                Command="{Binding GoToChatCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White"
                                FontSize="15"
                                FontAttributes="Bold"
                                Padding="24,12"
                                CornerRadius="12"
                                Margin="0,8,0,0"
                                HorizontalOptions="Center"/>
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:Product">
                        <Border BackgroundColor="White"
                                    Padding="16"
                                    Margin="0,0,0,12">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12"/>
                                </Border.StrokeShape>
                                <Border.Shadow>
                                    <Shadow Brush="Black"
                                            Offset="0,2"
                                            Radius="8"
                                            Opacity="0.06"/>
                                </Border.Shadow>
                                
                                <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="10">
                                    <!-- Product Image and Name -->
                                    <Grid Grid.Row="0" ColumnDefinitions="100,*,50" ColumnSpacing="10">
                                        <Border WidthRequest="100"
                                                HeightRequest="100"
                                                BackgroundColor="White"
                                                StrokeThickness="1"
                                                Stroke="{StaticResource BorderLight}"
                                                Padding="4">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="8"/>
                                            </Border.StrokeShape>
                                            <Grid>
                                                <Image Source="{Binding ImageUrl, Converter={StaticResource ImageUrlProxyConverter}}"
                                                       Aspect="AspectFit"
                                                       BackgroundColor="Transparent"/>
                                                <Border BackgroundColor="{StaticResource Gray50}"
                                                        HorizontalOptions="Fill"
                                                        VerticalOptions="Fill">
                                                    <Border.Triggers>
                                                        <DataTrigger TargetType="Border" Binding="{Binding ImageUrl, Converter={StaticResource StringToBoolConverter}}" Value="True">
                                                            <Setter Property="IsVisible" Value="False"/>
                                                        </DataTrigger>
                                                    </Border.Triggers>
                                                    <Border.StrokeShape>
                                                        <RoundRectangle CornerRadius="4"/>
                                                    </Border.StrokeShape>
                                                    <VerticalStackLayout HorizontalOptions="Center"
                                                                         VerticalOptions="Center"
                                                                         Spacing="4">
                                                        <Label Text="ðŸ›ï¸"
                                                               FontSize="40"
                                                               HorizontalOptions="Center"
                                                               Opacity="0.5"/>
                                                        <Label Text="No Image"
                                                               FontSize="10"
                                                               TextColor="{StaticResource TextTertiary}"
                                                               HorizontalOptions="Center"
                                                               Opacity="0.7"/>
                                                    </VerticalStackLayout>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        
                                        <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center" Margin="0,0,8,0">
                                            <Label Text="{Binding Name}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource TextPrimary}"
                                                   LineBreakMode="WordWrap"
                                                   MaxLines="2"/>
                                            <Label FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}">
                                                <Label.Text>
                                                    <MultiBinding StringFormat="{}{0:#,##0} {1}">
                                                        <Binding Path="Price" />
                                                        <Binding Path="Currency" />
                                                    </MultiBinding>
                                                </Label.Text>
                                            </Label>
                                        </VerticalStackLayout>
                                        
                                        <!-- Delete Button -->
                                        <Button Grid.Column="2"
                                                Text="ðŸ—‘ï¸"
                                                FontSize="18"
                                                WidthRequest="44"
                                                HeightRequest="44"
                                                CornerRadius="22"
                                                Padding="0"
                                                BackgroundColor="{StaticResource Error}"
                                                TextColor="White"
                                                VerticalOptions="Start"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeleteProductCommand}"
                                                CommandParameter="{Binding .}"/>
                                    </Grid>
                                    
                                    <!-- Store Name -->
                                    <HorizontalStackLayout Grid.Row="1" Spacing="6">
                                        <Label Text="ðŸª"
                                               FontSize="14"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding StoreName}"
                                               FontSize="14"
                                               TextColor="{StaticResource TextSecondary}"
                                               VerticalOptions="Center"/>
                                    </HorizontalStackLayout>
                                    
                                    <!-- Product URL (Clickable) -->
                                    <Border Grid.Row="2"
                                            BackgroundColor="{StaticResource Primary}"
                                            Padding="12,8"
                                            HorizontalOptions="Start">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="8"/>
                                        </Border.StrokeShape>
                                        <Border.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.OpenProductUrlCommand}"
                                                                 CommandParameter="{Binding ProductUrl}"/>
                                        </Border.GestureRecognizers>
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="ðŸ”—"
                                                   FontSize="16"
                                                   TextColor="White"
                                                   VerticalOptions="Center"/>
                                            <Label Text="View Product"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="White"
                                                   VerticalOptions="Center"/>
                                        </HorizontalStackLayout>
                                    </Border>
                                    
                                    <!-- Date Added -->
                                    <HorizontalStackLayout Grid.Row="3" Spacing="6">
                                        <Label Text="ðŸ“…"
                                               FontSize="12"
                                               VerticalOptions="Center"/>
                                        <Label FontSize="12"
                                               TextColor="{StaticResource TextTertiary}"
                                               VerticalOptions="Center">
                                            <Label.Text>
                                                <MultiBinding StringFormat="Added: {0:MMM dd, yyyy hh:mm tt}">
                                                    <Binding Path="CreatedAt" />
                                                </MultiBinding>
                                            </Label.Text>
                                        </Label>
                                    </HorizontalStackLayout>
                                </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>
    </Grid>
</ContentPage>

